## 别找`Oracle pl/sql`与`PG plpgsql`的存储过程/函数语法转换工具了, 用AI就可以!  
        
### 作者        
digoal        
        
### 日期        
2024-12-31        
        
### 标签        
PostgreSQL , PolarDB , DuckDB , AI , Oracle , pl/sql , plpgsql , 存储过程 , 函数 , 迁移 , 兼容性   
        
----        
        
## 背景       
别找`Oracle pl/sql`与`PG plpgsql`的存储过程/函数语法转换工具了, 用AI就可以!  
  
我拿菜鸟教程里Oracle pl/sql例子试了一下, AI真的搞定了.  
  
https://www.cainiaoya.com/plsql/plsql-coll.html  
  
万能的AI, 麻烦你把这个oracle pl/sql存储过程改成PostgreSQL plpgsql存储过程.  
```  
DECLARE   
   TYPE names_table IS TABLE OF VARCHAR2(10);   
   TYPE grades IS TABLE OF INTEGER;    
   names names_table;   
   marks grades;   
   total integer;   
BEGIN   
   names := names_table('Kavita', 'Pritam', 'Ayan', 'Rishav', 'Aziz');   
   marks:= grades(98, 97, 78, 87, 92);   
   total := names.count;   
   dbms_output.put_line('Total '|| total || ' Students');   
   FOR i IN 1 .. total LOOP   
      dbms_output.put_line('Student:'||names(i)||', Marks:' || marks(i));   
   end loop;   
END;   
/    
```  
  
---  
  
在将 Oracle PL/SQL 存储过程转换为 PostgreSQL PL/pgSQL 时，需要注意以下几个关键点：  
  
1. **数组和集合类型**：在 Oracle 中，使用 `TABLE` 类型来定义集合（如 `names_table` 和 `grades`），而在 PostgreSQL 中没有直接的 `TABLE` 类型。可以使用 **数组**（`ARRAY`）来代替集合。  
2. **`DBMS_OUTPUT.PUT_LINE`**：在 PostgreSQL 中，可以使用 `RAISE NOTICE` 来替代 Oracle 的 `DBMS_OUTPUT.PUT_LINE`。  
3. **`count`**：在 Oracle 中，集合的 `count` 方法用来获取元素的个数。PostgreSQL 数组可以使用 `array_length` 函数来获取数组的长度。  
  
### Oracle PL/SQL 示例：  
  
```plsql  
DECLARE   
   TYPE names_table IS TABLE OF VARCHAR2(10);   
   TYPE grades IS TABLE OF INTEGER;    
   names names_table;   
   marks grades;   
   total integer;   
BEGIN   
   names := names_table('Kavita', 'Pritam', 'Ayan', 'Rishav', 'Aziz');   
   marks := grades(98, 97, 78, 87, 92);   
   total := names.count;   
   dbms_output.put_line('Total ' || total || ' Students');   
   FOR i IN 1 .. total LOOP   
      dbms_output.put_line('Student: ' || names(i) || ', Marks: ' || marks(i));   
   END LOOP;   
END;  
/  
```  
  
### 转换为 PostgreSQL PL/pgSQL 示例：  
  
```plpgsql  
DO $$   
DECLARE  
   names TEXT[] := ARRAY['Kavita', 'Pritam', 'Ayan', 'Rishav', 'Aziz'];   
   marks INTEGER[] := ARRAY[98, 97, 78, 87, 92];   
   total INTEGER;   
BEGIN  
   -- 获取学生数量  
   total := array_length(names, 1);   
     
   RAISE NOTICE 'Total % Students', total;  
     
   -- 循环遍历学生和成绩  
   FOR i IN 1..total LOOP   
      RAISE NOTICE 'Student: %, Marks: %', names[i], marks[i];   
   END LOOP;   
END $$;  
```  
  
### 主要变动解释：  
  
1. **数组类型替换**：  
   - 在 Oracle 中，`names_table` 和 `grades` 使用 `TABLE` 类型定义了集合。在 PostgreSQL 中，我们使用 **数组**（`TEXT[]` 和 `INTEGER[]`）来代替。  
     
2. **数组初始化**：  
   - 在 Oracle 中，`names` 和 `marks` 使用了类型的初始化方法（`names_table('Kavita', 'Pritam', ...)`）。在 PostgreSQL 中，使用 `ARRAY[]` 来初始化数组。  
  
3. **`count` 替代**：  
   - 在 Oracle 中，使用 `names.count` 来获取数组的大小。在 PostgreSQL 中，使用 `array_length` 函数来获取数组的长度：`array_length(names, 1)`。`1` 是指定第一个维度的长度。  
  
4. **输出**：  
   - 在 Oracle 中，使用 `dbms_output.put_line` 输出信息，而在 PostgreSQL 中，使用 `RAISE NOTICE` 来输出信息。`RAISE NOTICE` 支持格式化输出，因此可以直接使用类似 `RAISE NOTICE 'text', var1, var2` 的方式。  
  
### 执行方法：  
- 在 PostgreSQL 中，如果你希望将这个代码变成一个存储过程，可以使用 `CREATE PROCEDURE`，而不是 `DO $$` 块。使用 `DO $$` 块是用于执行匿名代码块。  
  
如果要创建一个存储过程，可以如下所示：  
  
```plpgsql  
CREATE OR REPLACE PROCEDURE student_marks()  
LANGUAGE plpgsql  
AS $$  
DECLARE  
   names TEXT[] := ARRAY['Kavita', 'Pritam', 'Ayan', 'Rishav', 'Aziz'];   
   marks INTEGER[] := ARRAY[98, 97, 78, 87, 92];   
   total INTEGER;   
BEGIN  
   total := array_length(names, 1);  
   RAISE NOTICE 'Total % Students', total;  
  
   FOR i IN 1..total LOOP   
      RAISE NOTICE 'Student: %, Marks: %', names[i], marks[i];   
   END LOOP;   
END;  
$$;  
```  
  
通过 `CALL student_marks();` 调用这个存储过程。  
  
### 总结：  
- 在 PostgreSQL 中使用数组代替 Oracle 中的 `TABLE` 类型。  
- 使用 `array_length` 获取数组长度。  
- 使用 `RAISE NOTICE` 代替 `DBMS_OUTPUT.PUT_LINE` 输出调试信息。  
      
---  
  
运行结果正确  
```  
postgres=# CALL student_marks();  
NOTICE:  Total 5 Students  
NOTICE:  Student: Kavita, Marks: 98  
NOTICE:  Student: Pritam, Marks: 97  
NOTICE:  Student: Ayan, Marks: 78  
NOTICE:  Student: Rishav, Marks: 87  
NOTICE:  Student: Aziz, Marks: 92  
CALL  
      
-- 和Oracle结果一致:  
  
Total 5 Students   
Student:Kavita, Marks:98   
Student:Pritam, Marks:97   
Student:Ayan, Marks:78   
Student:Rishav, Marks:87   
Student:Aziz, Marks:92    
PL/SQL procedure successfully completed.   
```  
    
大家可以试试逻辑和语法更加复杂的, 或者试试需要自定义类型, 自定义包的.     
     

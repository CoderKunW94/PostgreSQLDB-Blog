## PolarDB 100 问 | `Failed to get the instance memory usage`  
                  
### 作者                  
digoal                  
                  
### 日期                  
2024-12-26                  
                  
### 标签                  
PostgreSQL , PolarDB , DuckDB , macOS , cgroup , Linux          
             
----             
              
## 背景    
  
### 问题   
使用这个方法在macOS 中部署的PolarDB. [《穷鬼玩PolarDB RAC一写多读集群系列 | 在Docker容器中用loop设备模拟共享存储搭建PolarDB RAC》](../202412/20241216_03.md)    
  
但是每秒都在打印一个告警, 虽然不影响数据库的使用, 但是看着很难受啊.  
  
PolarDB 节点启动后, 一直存在如下警告, 不知道是何原因?      
```  
告警来自实例本地数据目录日志文件中 $PGDATA/pg_log/xxx_error.log  
...   
207                     2024-12-24 14:48:13.410 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:13.910 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:14.410 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:14.910 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:15.410 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:15.911 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:16.411 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:16.912 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:17.413 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:17.913 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:18.413 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:18.914 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:19.414 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:19.914 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:20.415 CST     WARNING:  Failed to get the instance memory usage  
207                     2024-12-24 14:48:20.915 CST     WARNING:  Failed to get the instance memory usage  
```  
     
报错代码来自PolarDB `external/polar_resource_manager/polar_resource_manager.c`     
```  
/*  
 * check ins memory  
 */  
void  
polar_check_mem_exceed(void)  
{  
        Size            pfsd_rss = 0;  
        Size            ins_rss_limit = 0;  
        Size            ins_mem_limit = 0;  
        Size            ins_mem_usage = 0;  
        Size            ins_rss = 0;  
        Size            ins_mapped_file = 0;  
  
        /* Get instance memory limit and memory usage */  
        if (polar_get_ins_memorystat(&ins_rss, &ins_mapped_file, &ins_rss_limit) != 0)  
        {  
                elog(WARNING, "Failed to get the instance memory usage");  
                return;  
        }  
  
        /* Get the pfsdaemon process rss */  
        if (enable_account_otherproc && polar_get_procrss_by_name("(pfsdaemon)", &pfsd_pid, &pfsd_rss) != 0)  
        {  
                pfsd_pid = InvalidPid;  
                elog(DEBUG1, "Failed to get the pfsdaemon rss");  
        }  
  
        /* Calculate memory limit, memory request and memory usage */  
        ins_mem_limit = Min(ins_rss_limit / 100 * total_mem_limit_rate, ins_rss_limit - total_mem_limit_remain_size * 1024);  
        /* mapped_file is generated by DSM */  
        ins_mem_usage = ins_rss + ins_mapped_file + pfsd_rss;  
  
        /*  
         * total mem usage reach mem limit evict resource manager to release  
         * exceed_rss memory  
         */  
        /* priority to release resource manager which exceed limit */  
        /* After setting the random policy, other release methods will be shielded */  
        if (mem_release_policy == TERMINATE_ANY_RANDOM && ins_mem_usage > ins_mem_limit)  
        {  
                if (enable_log)  
                        ereport(LOG, (errmsg("[polar_resource_manager] For Random Policy: Instance memory usage database memory %lu bytes, "  
                                                                 "database dynamic shared memory %lu bytes, pfsd memory %lu bytes",  
                                                                 ins_rss, ins_mapped_file, pfsd_rss)));  
  
                /* The idle process will be released first */  
                polar_throttle_mem_random(ins_mem_usage, ins_mem_limit, RM_TBLOCK_DEFAULT, idle_terminate_num);  
  
                /*  
                 * Since the memory size of the process is not obtained under the  
                 * random policy, it is necessary to obtain the instance memory usage  
                 * again to determine whether to release the active sessions.  
                 */  
                if (polar_get_ins_memorystat(&ins_rss, &ins_mapped_file, &ins_rss_limit) != 0)  
                {  
                        elog(WARNING, "Failed to get the instance memory usage");  
                        return;  
                }  
  
                if (enable_account_otherproc && polar_get_procrss_by_name("(pfsdaemon)", &pfsd_pid, &pfsd_rss) != 0)  
                {  
                        pfsd_pid = InvalidPid;  
                        elog(DEBUG1, "Failed to get the pfsdaemon rss");  
                }  
  
                ins_mem_usage = ins_rss + ins_mapped_file + pfsd_rss;  
  
                /* If the memory still exceeds the limit, release the active session */  
                if (ins_mem_usage > ins_mem_limit)  
                        polar_throttle_mem_random(ins_mem_usage, ins_mem_limit, RM_TBLOCK_INPROGRESS, active_terminate_num);  
        }  
        else if (ins_mem_usage > ins_mem_limit)  
        {  
                /*  
                 * When the memory is larger than the memory limit, it will perform  
                 * the forced release memory mode.  
                 */  
                if (enable_log)  
                        ereport(LOG, (errmsg("[polar_resource_manager] For Limit: Instance memory usage database memory %lu bytes, "  
                                                                 "database dynamic shared memory %lu bytes, pfsd memory %lu bytes",  
                                                                 ins_rss, ins_mapped_file, pfsd_rss)));  
  
                polar_throttle_mem(ins_mem_usage, ins_mem_limit, true);  
        }  
}  
```  
      
### 问题分析  
关于这个warning, PolarDB研发的回复来了!     
  
该功能为监控内存占用，如果过高会 `terminate backend`, 防止 OS 的 `kill -9` .    
  
监控数据来自`Linux cgroup:   /sys/fs/cgroup/memory/memory.stat`     
  
但是在macOS 的docker容器内容, 该文件为: `/sys/fs/cgroup/memory.stat`  
  
所以PolarDB一直报无法获取数据`Failed to get the instance memory usage`.  
  
至于为什么macOS内的docker 容器cgroup目录和Linux中的目录不一致, 暂时不得而知.    
  
猜测和macOS的Docker是模拟出来的原因, 路径未模拟正确?      
  
临时解决办法:   
- 通过 polar_resource_manager.enable_resource_manager 参数设置为off , 关闭这个功能就可以了.  
- 或者修改获取该信息的源码: ` external/polar_resource_manager/polar_resource_manager.c `  
    ```  
    /*  
     * _PG_init gets called when the extension is loaded.  
     */  
    void  
    _PG_init(void)  
    {  
    ...  
            DefineCustomStringVariable(  
                                                               "polar_resource_manager.cgroup_mem_prefix_path",  
                                                               gettext_noop("Database in which polar_resource_manager metadata is kept."),  
                                                               NULL,  
                                                               &cgroup_mem_prefix_path,  
                                                               "/sys/fs/cgroup/memory/",   // 改这里     
                                                               PGC_POSTMASTER,  
                                                               GUC_SUPERUSER_ONLY | POLAR_GUC_IS_VISIBLE | POLAR_GUC_IS_CHANGABLE,  
                                                               check_cgroupmem_prefix, NULL, NULL);  
    ```  
    
长期来说, 大多数生产环境会部署在Linux为宿主机的容器中, 所以不会有这个告警.     
    
## 参考    
[《穷鬼玩PolarDB RAC一写多读集群系列 | 在Docker容器中用loop设备模拟共享存储搭建PolarDB RAC》](../202412/20241216_03.md)    
    

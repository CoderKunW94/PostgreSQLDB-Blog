## PostgreSQL 19 preview - 新增视图pg_dsm_registry_allocations    
                            
### 作者                            
digoal                            
                            
### 日期                            
2025-07-14                            
                            
### 标签                            
PostgreSQL , PolarDB , DuckDB , 动态共享内存 , 内存分配信息 , pg_dsm_registry_allocations      
                            
----                            
                            
## 背景                 
https://github.com/postgres/postgres/commit/167ed8082f40ee1f3f4cd18cf02bd6d17df57dab              
            
Commit 167ed80（全称: 167ed8082f40ee1f3f4cd18cf02bd6d17df57dab）为PostgreSQL引入了一个新的系统视图：pg_dsm_registry_allocations。  
  
### 主要内容  
- **新增视图**：`pg_dsm_registry_allocations`  
  - 该视图用于展示动态共享内存（DSM）注册表中的内存分配信息。  
  - 返回每个分配项的名称、类型和大小。  
  - 类型包括：segment（段）、area（区域）、hash（哈希表）。但对于类型为area和hash的分配，由于需要先attach才能知道实际大小，因此size字段为NULL。  
- **权限设置**：  
  - 只有超级用户或拥有`pg_read_all_stats`角色的用户可以读取该视图。  
- **文档和测试**：  
  - 系统视图文档增加了该视图的详细说明。  
  - 添加了相关SQL和回归测试，确保权限校验和功能正确。  
  
### 代码影响  
- 在`src/backend/storage/ipc/dsm_registry.c`中实现了核心逻辑，遍历DSM注册表并输出分配信息。  
- `src/backend/catalog/system_views.sql`中创建了系统视图。  
- 相关的catalog、测试SQL和输出文件均做了相应更新。  
- `catversion`（系统目录版本号）自增，表示有catalog变更。  
  
### 适用场景  
该视图方便DBA或开发者查询和排查动态共享内存的使用情况，尤其对于使用DSM扩展的场景非常有用。  
  
---  
**原始commit地址**：[commit 167ed80](https://github.com/postgres/postgres/commit/167ed8082f40ee1f3f4cd18cf02bd6d17df57dab)  
  
如需详细diff或具体代码行解读，可进一步提问。  
     

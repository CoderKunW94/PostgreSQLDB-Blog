## 维基百科(wikipedia) RAG 优化 | PolarDB + AI   
      
### 作者      
digoal      
      
### 日期      
2025-04-17      
      
### 标签      
PostgreSQL , PolarDB , DuckDB , RAG   
      
----      
      
## 背景  
  
下面这篇文章介绍了为什么RAG的效果不理想?  
- [《为什么用了RAG, 我的AI还是笨得跟猪一样! RAG效果评测与优化》](../202504/20250414_04.md)    
  
原因不再赘述, 本文将以维基百科的数据集为例, 用PolarDB PostgreSQL数据库进行管理, 说明如何通过以下手段提高召回覆盖率和召回精度.    
- 分段方法  
- 提取QA pairs  
- 提取标签s  
- 全文检索  
- 模糊查询  
- 标签检索  
- 向量检索  
- rerank  
  
## 准备环境  
  
假设你已经部署好了如下环境  
  
[《穷鬼玩PolarDB RAC一写多读集群系列 | 在Docker容器中用loop设备模拟共享存储搭建PolarDB RAC》](../202412/20241216_03.md)    
  
[《穷鬼玩PolarDB RAC一写多读集群系列 | 接入私有化大模型服务》](../202412/20241230_02.md)    
  
## 下载维基百科数据集  
用到命令行工具  
  
https://huggingface.co/docs/huggingface_hub/main/en/guides/cli  
  
```  
pip install -U "huggingface_hub[cli]"  
```  
  
维基百科数据集如下, 页面中有数据格式, 分为4个字段 `id, url, title, text`  
  
https://huggingface.co/datasets/wikimedia/wikipedia  
  
我们可以只下载中文的数据集  
  
https://huggingface.co/datasets/wikimedia/wikipedia/tree/main/20231101.zh   
  
```  
train-00000-of-00006.parquet  
train-00001-of-00006.parquet  
...  
train-00005-of-00006.parquet  
```  
  
新建目录  
```  
mkdir ~/wiki  
```  
  
下载  
```  
HF_ENDPOINT=http://hf-mirror.com nohup huggingface-cli download wikimedia/wikipedia --include 20231101.zh/* --repo-type dataset --local-dir ~/wiki --cache-dir ~/wiki/.cache --resume-download --max-workers 1 >~/wiki/download.log 2>&1 &    
```  
  
PS:   
  
本来duckdb可以直接下载hf的数据集, 但是它不会自动使用代理. 导致访问失败    
  
https://huggingface.co/docs/hub/en/datasets-duckdb  
  
```  
$ HF_ENDPOINT=http://hf-mirror.com ./duckdb   
v1.2.1 8e52ec4395  
Enter ".help" for usage hints.  
Connected to a transient in-memory database.  
Use ".open FILENAME" to reopen on a persistent database.  
D select * from 'hf://datasets/wikimedia/wikipedia/20231101.zh/*.parquet' limit 1;  
IO Error:  
SSL connection failed error for HTTP GET to 'https://huggingface.co/api/datasets/wikimedia/wikipedia/tree/main/20231101.zh' with status 1718054505  
```  
  
  
## 将维基百科数据集导入PolarDB  
  
将下载好的parquet文件放到PolarDB容器可以访问到的地方  
```  
mv ~/wiki ~/data_volumn/  
  
  
./20231101.zh:   
total 3481600  
-rw-r--r--  1 digoal  staff   560M Apr 17 14:28 train-00000-of-00006.parquet  
-rw-r--r--  1 digoal  staff   251M Apr 17 14:29 train-00001-of-00006.parquet  
-rw-r--r--  1 digoal  staff   121M Apr 17 14:30 train-00002-of-00006.parquet  
-rw-r--r--  1 digoal  staff   250M Apr 17 14:32 train-00003-of-00006.parquet  
-rw-r--r--  1 digoal  staff   245M Apr 17 14:33 train-00004-of-00006.parquet  
-rw-r--r--  1 digoal  staff   214M Apr 17 14:34 train-00005-of-00006.parquet  
drwxr-xr-x  4 digoal  staff   128B Apr 17 14:34 ..  
drwxr-xr-x  8 digoal  staff   256B Apr 17 14:34 .  
```  
  
  
进入PolarDB容器  
```  
docker exec -ti pb1 bash  
```  
  
下载duckdb  
```  
cd /data  
wget https://github.com/duckdb/duckdb/releases/download/v1.2.2/duckdb_cli-linux-aarch64.zip  
sudo apt install -y unzip  
unzip duckdb_cli-linux-aarch64.zip   
```  
  
使用DuckDB查询数据集  
```  
./duckdb  
D load postgres_scanner;  
100% ▕████████████████████████████████████████████████████████████▏   
D select * from '/data/wiki/20231101.zh/*.parquet' limit 10000;  
┌─────────┬──────────────────────┬────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  
│   id    │         url          │     title      │                                                                         text                                                                         │  
│ varchar │       varchar        │    varchar     │                                                                       varchar                                                                        │  
├─────────┼──────────────────────┼────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤  
│ 13      │ https://zh.wikiped…  │ 数学           │ 数学，是研究數量、结构以及空间等概念及其变化的一門学科，屬於形式科學的一種。數學利用抽象化和邏輯推理，從計數、計算、量度、對物體形狀及運動的觀察發…  │  
│ 18      │ https://zh.wikiped…  │ 哲学           │ 哲學是研究普遍的、基本问题的学科，包括存在、知识、价值、理智、心灵、语言等领域。哲学与其他学科不同之處在於哲學有獨特之思考方式，例如批判的方式、通…  │  
│ 21      │ https://zh.wikiped…  │ 文學           │ 文學（），在狭义上，是一种语言艺术，亦即使用语言文字为手段，形象化地反映客观社会生活、表达主观作者思想感情的一种艺术。文学不仅强调传达思想观念，更…  │  
│ 22      │ https://zh.wikiped…  │ 历史           │ 歷史（现代汉语词汇，古典文言文称之为史），指人类社会过去的事件和行动，以及对这些事件行为有系统的记录、诠释和研究。歷史可提供今人理解過去，作為未來…  │  
│ 25      │ https://zh.wikiped…  │ 计算机科学     │ 计算机科学（，有时缩写为）是系统性研究信息与计算的理论基础以及它们在计算机系统中如何实现与应用的实用技术的学科。 它通常被形容为对那些创造、描述以…   │  
│ 39      │ https://zh.wikiped…  │ 民族           │ 在中華人民共和國，民族是一個根據文化與血緣傳承而形成的共同體，經中華人民共和國法律認定而形成。這個单词源自19世紀的歐洲與美國，經日本傳入中國，在意…  │  
│ 45      │ https://zh.wikiped…  │ 戲劇           │ 戏剧（）是演員將某個故事或情境，以對話、歌唱或動作等方式所表演出來的藝術。戏剧有四個元素，包括了「演員」、「故事（情境）」、「舞台（表演場地）」和…  │  
│ 48      │ https://zh.wikiped…  │ 电影           │ 电影（/ ），特点是运动／移动的画面（），是一种视觉艺术作品，用来模拟透過使用动态图像来传达思想、故事、感知、感觉、美或氛围的体验。这些图像通常伴有…  │  
│ 51      │ https://zh.wikiped…  │ 音乐           │ 音樂，廣義而言，就是指任何以聲音組成的藝術。英文Music一詞源於古希臘語的μουσική（mousike），意即缪斯（muse）女神的藝術。而中文的音樂二字，許慎《說…   │  
│ 53      │ https://zh.wikiped…  │ 经济学         │ 經濟學（），為研究商品和服務關係的社會科學學門，包括其中所有的購買、生產、分配和消費等行為。\n\n普通經濟學側重於研究經濟主體和客體之間的實力變化，…  │  
│ 56      │ https://zh.wikiped…  │ 政治学         │ 政治學，或稱政治科學等，是一門对政治、治理和權力體系进行科學研究，分析政治活動、政治制度、政治思想和行為以及相關憲法和法律的社會科學。 政治學涉及…   │  
│ 57      │ https://zh.wikiped…  │ 法学           │ 法學（jurisprudence、legal theory），法律学、法律科学，是社會科學中的1門學科，研究法律此一特定社會現象、其本质与規律。所有的秩序都可以說是種「法律…  │  
│ 59      │ https://zh.wikiped…  │ 社会学         │ 社會學（）起源於19世紀末期，是一門研究社會的學科。社會學使用各種研究方法進行實證調查和批判分析，以發展及完善一套有關人類社會結構、社會行動或社會關…  │  
│ 62      │ https://zh.wikiped…  │ 军事学         │ 军事学与甚多範疇有關，主要與战争有关。此外，軍事學本身包含了各種學問。军事是政治的一部分，战争是政治的一种延续，是一国或者集团用暴力手段达到自己目…  │  
│ 66      │ https://zh.wikiped…  │ 信息科学       │ 信息科学（Information science），旧称情报学（漢語中的日語借詞），主要是指以信息为研究对象，包含資訊的分析、收集、分類、處理、儲存、檢索、傳播和保…   │  
│ 67      │ https://zh.wikiped…  │ 物理学         │ 物理學（源自，源自，转写：phýsis，直譯：大自然）是研究物質、能量的本質與性質的自然科學。由於物質與能量是所有科學研究的必須涉及的基本要素，所以物理…  │  
│ 70      │ https://zh.wikiped…  │ 天文學         │ 天文學是一門研究天體和天文現象的自然科學。它使用數學、物理和化學來解釋它們的起源和演化。天文學的研究對象包括：行星、衛星、恒星、星雲、星系和彗星等…  │  
│ 72      │ https://zh.wikiped…  │ 力学           │ 力学（）是物理学的一个分支，主要研究能量和力以及它们与物体的平衡、变形或运动的关系。\n\n发展历史 \n人们在日常劳动中使用杠杆、打水器具等等，逐渐认…   │  
│ 74      │ https://zh.wikiped…  │ 化學           │ 化學是一門研究物質的性質、組成、結構、以及变化规律的物理的子學科。化學研究的對象涉及物質之間的相互關係，或物質和能量之間的關聯。傳統的化學常常都是…  │  
│ 76      │ https://zh.wikiped…  │ 地理学         │ 地理學（）是探索地球及其特徵、居民和現象的學問，研究地球表層各圈層相互作用關係，及其空間差異與變化過程的學科體系。\n\n词源 \n英語geography一詞源自…  │  
│ ·       │          ·           │   ·            │                                                                          ·                                                                           │  
│ ·       │          ·           │   ·            │                                                                          ·                                                                           │  
│ ·       │          ·           │   ·            │                                                                          ·                                                                           │  
│ 35312   │ https://zh.wikiped…  │ 江门市         │ 江门市（官方音譯：，传统外文：、Kongmun、Kiangmoon），又称四邑、五邑，简称邑，是中华人民共和国广东省下辖的地级市，位于广东省南部，是粵港澳大灣區的…  │  
│ 35313   │ https://zh.wikiped…  │ 新会区         │ 新會（粵語新會話：，汉语拼音：），簡稱新或會，古稱冈州，因盛產蒲葵而别稱葵乡，現為中國廣東省江門市下轄的市轄區，位於珠江三角洲西部西江、潭江下游匯…  │  
│ 35314   │ https://zh.wikiped…  │ PID控制器      │ PID控制器（比例-积分-微分控制器），由比例单元（Proportional）、积分单元（Integral）和微分单元（Derivative）组成。可以透過調整這三個單元的增益，和…   │  
│ 35319   │ https://zh.wikiped…  │ 格 (数学)      │ 在数学中，格（）是其非空有限子集都有一个上确界（称为并）和一个下确界（称为交）的偏序集合（poset）。格也可以特征化为满足特定公理恒等式的代数结构。…   │  
│ 35325   │ https://zh.wikiped…  │ 半格           │ 设是一个偏序集，若对于任意的，都有最小上界（并），或者对于任意的，都有最大下界（交），则称构成一个半格。\n\n也可以将半格定义为一个代数结构。一个半…  │  
│ 35329   │ https://zh.wikiped…  │ 偏序关系       │ 偏序集合（，简写）是数学中，特别是序理论中，指配备了偏序关系的集合。\n这个理论将对集合的元素进行排序、顺序或排列等直觉概念抽象化。这种排序不必是全…  │  
│ 35331   │ https://zh.wikiped…  │ 二元关系       │ 数学上，二元关系（，或简称关系）用於讨论两种物件的连系。诸如算术中的「大於」及「等於」、几何学中的「相似」或集合论中的「为……之元素」、「为……之子集…  │  
│ 35333   │ https://zh.wikiped…  │ 袋狼           │ 袋狼（學名：），现已全部灭绝，因其身上斑纹似虎，又名塔斯马尼亚虎，曾广泛分布于新几内亚热带雨林、澳大利亚草原等地，後因人類活動只分布於塔斯馬尼亞島…  │  
│ 35334   │ https://zh.wikiped…  │ 金属材料       │ 金屬材料一般是指工業工程應用中的純金屬或合金。自然界中大約有70多種純金屬，其中常見的有金、銀、銅、鐵、鋁、錫、鎳、鉛、鋅、碳等等。而合金常指二種或…  │  
│ 35335   │ https://zh.wikiped…  │ 笛卡儿积       │ 在数学中，两个集合和的笛卡儿积（），又称直积，在集合论中表示为，是所有可能的有序对組成的集合，其中有序對的第一个对象是的成员，第二个对象是的成员。…  │  
│ 35336   │ https://zh.wikiped…  │ 有序对         │ 在数学中，有序对是两个对象的搜集，使得可以区分出其中一个是“第一个元素”而另一个是“第二个元素”（第一个元素和第二个元素也叫做左投影和右投影）。带有第…  │  
│ 35340   │ https://zh.wikiped…  │ 金屬基複合材料 │ 金属基复合材料（Metal Matrix Composite，MMC）一般是以金属或合金为连续相而颗粒，晶须或纤维形式的第二相组成的复合材料。目前其制备和加工比较困难，成…   │  
│ 35343   │ https://zh.wikiped…  │ 等价关系       │ 在数学中，等價關係（）是具有自反性，对称性，传递性的二元关系。等价关系也称为同值關係。一些等价关系的例子包括整数集上的同余，欧氏几何中的等量（），…  │  
│ 35344   │ https://zh.wikiped…  │ 666            │ 666（六百六十六）是665与667之间的自然数。\n\n在数学中 \n 666是第667个非負整数。\n 666是第333个双数，又是第544个合数。（第666个合数是806 = 2 × 13 ×…  │  
│ 35347   │ https://zh.wikiped…  │ 全序关系       │ 全序关系，也称为线性顺序（）即集合上的反对称的、传递的和完全的二元关系（一般称其为）。\n\n若满足全序关系，则下列陈述对于中的所有和成立：\n\n 反对…   │  
│ 35356   │ https://zh.wikiped…  │ 最小上界       │ 最小上界，亦称上确界（，记为sup E）是数学中序理论的一个重要概念，在格论和数学分析等领域有广泛应用。\n\n定义 \n给定偏序集合(T,≤)，对于S⊆T，S的上确…   │  
│ 35361   │ https://zh.wikiped…  │ 上界和下界     │ 設為一個偏序集，若存在，能滿足都有，則稱作集合的上界，若存在，能滿足都有，則稱作的下界。\n\n例如在實變數中，若存在一個實數，能滿足都有，則即為集合…  │  
│ 35363   │ https://zh.wikiped…  │ 最大下界       │ 在数学中，某个集合 X 的子集 E 的下确界( 或 ，记为 inf E )是小于或等于的 E 所有其他元素的最大元素，其不一定在 E 內。所以还常用术语最大下界（简写为 …  │  
│ 35366   │ https://zh.wikiped…  │ 软件开发       │ 软件开发（）是根据用户要求建造出软件系统或者系统中软件部分的一个产品开发的過程。软件开发是一项包括需求获取、开发规划、需求分析和设计、编程实现、软…  │  
│ 35372   │ https://zh.wikiped…  │ 纳米材料       │ 奈米材料广义上是三维空间中至少有一维处于奈米尺度范围或者由该尺度范围的物质为基本结构单元所构成的材料的总称。由于奈米尺寸的物质具有与宏观物质所迥异…  │  
├─────────┴──────────────────────┴────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤  
│ 10000 rows (40 shown)                                                                                                                                                                        4 columns │  
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
D   
```  
  
  
创建PolarDB数据库用户  
```  
$ psql  
  
create role digoal encrypted password '123456' login superuser;  
```  
  
将维基百科数据集导入PolarDB, 用到了DuckDB postgres_scanner插件.   
  
https://duckdb.org/docs/stable/extensions/postgres.html  
  
```  
./duckdb  
  
CREATE SECRET polardb_pb1 (  
    TYPE postgres,  
    HOST '127.0.0.1',  
    PORT 5432,  
    DATABASE postgres,  
    USER 'digoal',  
    PASSWORD '123456'  
);  
  
  
ATTACH '' AS pb1 (TYPE postgres, SECRET polardb_pb1);  
  
create table pb1.wiki (id int, url text, title text, content text);  
  
-- 例子   
  
insert into pb1.wiki select * from '/data/wiki/20231101.zh/*.parquet' limit 10000;	  
  
D select * from pb1.wiki limit 1;  
┌───────┬──────────────────────┬─────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  
│  id   │         url          │  title  │                                                                            content                                                                            │  
│ int32 │       varchar        │ varchar │                                                                            varchar                                                                            │  
├───────┼──────────────────────┼─────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤  
│  13   │ https://zh.wikiped…  │ 数学    │ 数学，是研究數量、结构以及空间等概念及其变化的一門学科，屬於形式科學的一種。數學利用抽象化和邏輯推理，從計數、計算、量度、對物體形狀及運動的觀察發展而成。…   │  
└───────┴──────────────────────┴─────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
D   
```  
  
PS: 如果你有足够的空间, 可以把parquet导出到csv, 然后使用psql copy来导入会更快.    
```  
-- duckdb  
./duckdb  
copy (select * from '/data/wiki/20231101.zh/*.parquet' ) to '/data/a.csv' (FORMAT csv, DELIMITER '|', HEADER);  
  
-- polardb  
psql   
copy wiki from '/data/a.csv' with (format csv, header on, DELIMITER '|', escape '"', QUOTE '"');  
COPY 1384748  
```  
  
  
## 准备插件和本地模型服务  
创建相应插件  
```  
$ psql  
psql (PostgreSQL 15.12 (PolarDB 15.12.3.0 build e1e6d85b debug) on aarch64-linux-gnu)  
Type "help" for help.  
  
postgres=# \d wiki  
                     Table "public.wiki"  
 Column  |       Type        | Collation | Nullable | Default   
---------+-------------------+-----------+----------+---------  
 id      | integer           |           |          |   
 url     | character varying |           |          |   
 title   | character varying |           |          |   
 content | character varying |           |          |   
  
postgres=# select count(*) from wiki ;  
  count    
---------  
 1384748  
(1 row)  
  
postgres=# create extension pg_bigm ;  
CREATE EXTENSION  
postgres=# create extension pg_jieba ;  
CREATE EXTENSION  
postgres=# create extension vector ;  
CREATE EXTENSION  
  
create extension http ;  
create extension openai ;   
```  
  
  
使用本地/远程模型   
```  
$ ollama list  
NAME                             ID              SIZE      MODIFIED       
qwen2.5-coder:3b                 e7149271c296    1.9 GB    5 hours ago       
ds-qwen2.5-1.5b-digoal:latest    2c6aaa8a497c    3.6 GB    7 weeks ago       
qwen2.5:1.5b                     65ec06548149    986 MB    7 weeks ago       
deepseek-r1:7b                   0a8c26691023    4.7 GB    2 months ago      
qwen_1.5b_test1:latest           682ad25636bd    1.1 GB    2 months ago      
deepseek-r1:1.5b                 a42b25d8c10a    1.1 GB    2 months ago      
deepseek-r1:14b                  ea35dfe18182    9.0 GB    2 months ago      
mxbai-embed-large:latest         468836162de7    669 MB    4 months ago   
  
启动本地模型  
  
OLLAMA_HOST=0.0.0.0:11434 OLLAMA_KEEP_ALIVE=-1 nohup ollama serve >> ~/.ollama.log 2>&1 &  
```  
  
  
指定模型API地址  
```  
psql  
  
alter database postgres set openai.api_uri = 'http://host.docker.internal:11434/v1/';  
```  
  
  
## 数据处理和检索优化  
1、分段  
  
  
可以使用pgai / postgresml, 对原始数据进行分段  
  
https://github.com/postgresml/postgresml?tab=readme-ov-file#chunk  
  
https://postgresml.org/docs/open-source/pgml/api/pgml.chunk  
  
https://www.cybertec-postgresql.com/en/pgai-importing-wikipedia-into-postgresql/  
  
https://python.langchain.com/docs/integrations/splitters/writer_text_splitter/#setup  
  
  
分段方法:  
  
https://docs.dify.ai/zh-hans/guides/knowledge-base/create-knowledge-and-upload-documents/chunking-and-cleaning-text  
  
  
  
2、对分段后的数据进行处理  
  
使用模型 总结Q/A pairs  
  
使用模型 总结标签: K_Vs  
  
  
  
3、对分段和以上数据进行向量化  
  
  
  
  
4、建立索引  
  
倒排索引 原始文本+Q/A 中文分词: 用于分词搜索  
倒排索引 原始文本+Q/A: 用于模糊查询   
倒排索引 总结标签 K_V 数组: 用于标签匹配(包含、相交)  
向量索引 向量字段: 用于语义搜索(向量相似)   
  
  
5、检索阶段   
  
混合搜索+rerank   
  
  
  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
